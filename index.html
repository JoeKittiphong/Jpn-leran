<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ฝึกภาษาญี่ปุ่น: ครบวงจร (เพิ่มคันจิ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes bounce-in {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-rose-50 text-slate-800 min-h-screen flex flex-col transition-colors duration-500" id="main-body">

    <div id="menu-screen" class="flex-1 flex flex-col items-center justify-center p-6 w-full max-w-md mx-auto animate-pop pb-12">
        
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#f43f5e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight mb-2">ฝึกฝนภาษาญี่ปุ่น</h1>
            <p class="text-slate-500 text-sm">เลือกโหมดที่ต้องการฝึก</p>
        </div>

        <div class="w-full space-y-3">
            <button onclick="startGame('hiragana')" class="w-full relative bg-white active:bg-rose-50 p-4 rounded-2xl shadow-sm border-2 border-rose-100 active:border-rose-300 transition-all text-left flex items-center justify-between group active:scale-[0.98]">
                <div>
                    <span class="block text-lg font-bold text-rose-600">Hiragana</span>
                    <span class="text-xs text-slate-400">อักษรพื้นฐาน (あ-ん)</span>
                </div>
                <span class="text-3xl text-rose-100 font-bold">あ</span>
            </button>

            <button onclick="startGame('katakana')" class="w-full relative bg-white active:bg-blue-50 p-4 rounded-2xl shadow-sm border-2 border-blue-100 active:border-blue-300 transition-all text-left flex items-center justify-between group active:scale-[0.98]">
                <div>
                    <span class="block text-lg font-bold text-blue-600">Katakana</span>
                    <span class="text-xs text-slate-400">คำทับศัพท์ (ア-ン)</span>
                </div>
                <span class="text-3xl text-blue-100 font-bold">ア</span>
            </button>
            
            <button onclick="startGame('reading')" class="w-full relative bg-white active:bg-violet-50 p-4 rounded-2xl shadow-sm border-2 border-violet-100 active:border-violet-300 transition-all text-left flex items-center justify-between group active:scale-[0.98]">
                <div>
                    <span class="block text-lg font-bold text-violet-600">ฝึกอ่าน (สำหรับมือใหม่)</span>
                    <span class="text-xs text-slate-400">ศัพท์ + คันจิ ➔ เลือกคำอ่าน</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-2xl text-violet-200 font-bold leading-none">よ</span>
                    <span class="text-xs text-violet-300 font-bold">อ่าน</span>
                </div>
            </button>

            <button onclick="startGame('n5')" class="w-full relative bg-white active:bg-emerald-50 p-4 rounded-2xl shadow-sm border-2 border-emerald-100 active:border-emerald-300 transition-all text-left flex items-center justify-between group active:scale-[0.98]">
                <div>
                    <span class="block text-lg font-bold text-emerald-600">จำศัพท์ N5</span>
                    <span class="text-xs text-slate-400">ศัพท์ ➔ เลือกความหมาย</span>
                </div>
                <span class="text-3xl text-emerald-100 font-bold">語</span>
            </button>

            <button onclick="startGame('mixed')" class="w-full relative bg-gradient-to-r from-rose-500 to-orange-400 active:opacity-90 p-4 rounded-2xl shadow-lg shadow-rose-200 transition-all text-left flex items-center justify-between text-white active:scale-[0.98]">
                <div>
                    <span class="block text-lg font-bold">รวมตัวอักษร (Mixed)</span>
                    <span class="text-xs opacity-90">ท้าทายทั้งสองแบบ</span>
                </div>
                <div class="flex gap-1 text-xl font-black opacity-30">
                    <span>あ</span><span>ア</span>
                </div>
            </button>
        </div>
        
        <p class="mt-8 text-xs text-slate-400">© 2025 Japanese Quiz App</p>
    </div>

    <div id="game-screen" class="hidden flex-1 flex-col items-center py-6 px-4 w-full max-w-md mx-auto">
        
        <div class="w-full flex justify-between items-center mb-6">
            <button onclick="returnToMenu()" class="p-3 bg-white rounded-xl shadow-sm text-slate-400 active:text-slate-600 active:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
            <div id="mode-badge" class="px-4 py-1.5 bg-white rounded-full shadow-sm text-xs font-bold text-slate-400 uppercase tracking-widest">
                MODE
            </div>
            <div class="w-10"></div>
        </div>

        <div class="w-full flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">คะแนนต่อเนื่อง</span>
                <span id="score-display" class="text-2xl font-bold text-rose-600 transition-all">0</span>
            </div>
            <div class="flex flex-col items-end">
                <div class="flex items-center gap-1 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2h-6c-2.21 0-4 1.79-4 4v5h14V6c0-2.21-1.79-4-4-4z"/></svg>
                    <span class="text-[10px] font-bold uppercase tracking-wider">สูงสุด</span>
                </div>
                <span id="highscore-display" class="text-xl font-bold text-slate-700">0</span>
            </div>
        </div>

        <div id="card-container" class="relative w-full bg-white rounded-3xl shadow-xl p-8 mb-4 flex flex-col items-center justify-center min-h-[260px] transition-all duration-200 border-2 border-transparent">
            
            <div id="sparkle-icon" class="hidden absolute top-4 right-4 text-green-500 animate-bounce-in">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
            </div>

            <div class="mb-2">
                <span id="question-label" class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full">นี่คือตัวอะไร?</span>
            </div>

            <p id="question-kanji" class="text-4xl md:text-5xl font-bold text-slate-200 mb-1 transition-all">
                </p>
            
            <h1 id="question-char" class="text-center font-black mb-1 text-slate-800 transition-all duration-200 break-words w-full">
                ?
            </h1>
            
            <p id="question-sub" class="hidden text-slate-500 text-lg font-medium mb-4">
                (ความหมาย)
            </p>

            <div class="h-6 w-full text-center">
                <p id="feedback-text" class="font-bold text-lg"></p>
            </div>
        </div>

        <div id="options-grid" class="w-full grid grid-cols-2 gap-3 mb-6">
            </div>

        <button onclick="resetScore()" class="mt-auto flex items-center gap-2 text-slate-400 hover:text-slate-600 transition-colors text-xs p-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
            <span>เริ่มใหม่ / รีเซ็ตคะแนน</span>
        </button>

    </div>

    <script>
        // --- DATASETS ---
        const hiraganaData = [
            { char: 'あ', romaji: 'a', thai: 'อะ' }, { char: 'い', romaji: 'i', thai: 'อิ' }, { char: 'う', romaji: 'u', thai: 'อุ' }, { char: 'え', romaji: 'e', thai: 'เอะ' }, { char: 'お', romaji: 'o', thai: 'โอะ' },
            { char: 'か', romaji: 'ka', thai: 'คะ' }, { char: 'き', romaji: 'ki', thai: 'คิ' }, { char: 'く', romaji: 'ku', thai: 'คุ' }, { char: 'け', romaji: 'ke', thai: 'เคะ' }, { char: 'こ', romaji: 'ko', thai: 'โคะ' },
            { char: 'さ', romaji: 'sa', thai: 'ซะ' }, { char: 'し', romaji: 'shi', thai: 'ชิ' }, { char: 'す', romaji: 'su', thai: 'สุ' }, { char: 'せ', romaji: 'se', thai: 'เซะ' }, { char: 'そ', romaji: 'so', thai: 'โซะ' },
            { char: 'た', romaji: 'ta', thai: 'ทะ' }, { char: 'ち', romaji: 'chi', thai: 'ฌิ' }, { char: 'つ', romaji: 'tsu', thai: 'ทสึ' }, { char: 'て', romaji: 'te', thai: 'เทะ' }, { char: 'と', romaji: 'to', thai: 'โทะ' },
            { char: 'な', romaji: 'na', thai: 'นะ' }, { char: 'に', romaji: 'ni', thai: 'นิ' }, { char: 'ぬ', romaji: 'nu', thai: 'นุ' }, { char: 'ね', romaji: 'ne', thai: 'เนะ' }, { char: 'の', romaji: 'no', thai: 'โนะ' },
            { char: 'は', romaji: 'ha', thai: 'ฮะ' }, { char: 'ひ', romaji: 'hi', thai: 'ฮิ' }, { char: 'ふ', romaji: 'fu', thai: 'ฟุ' }, { char: 'へ', romaji: 'he', thai: 'เฮะ' }, { char: 'ほ', romaji: 'ho', thai: 'โฮะ' },
            { char: 'ま', romaji: 'ma', thai: 'มะ' }, { char: 'み', romaji: 'mi', thai: 'มิ' }, { char: 'む', romaji: 'mu', thai: 'มุ' }, { char: 'め', romaji: 'me', thai: 'เมะ' }, { char: 'も', romaji: 'mo', thai: 'โมะ' },
            { char: 'や', romaji: 'ya', thai: 'ยะ' }, { char: 'ゆ', romaji: 'yu', thai: 'ยุ' }, { char: 'よ', romaji: 'yo', thai: 'โยะ' },
            { char: 'ら', romaji: 'ra', thai: 'ระ' }, { char: 'り', romaji: 'ri', thai: 'ริ' }, { char: 'る', romaji: 'ru', thai: 'รุ' }, { char: 'れ', romaji: 're', thai: 'เระ' }, { char: 'ろ', romaji: 'ro', thai: 'โระ' },
            { char: 'わ', romaji: 'wa', thai: 'วะ' }, { char: 'を', romaji: 'wo', thai: 'โวะ' }, { char: 'ん', romaji: 'n', thai: 'อึน/น' },
            { char: 'が', romaji: 'ga', thai: 'กะ' }, { char: 'ぎ', romaji: 'gi', thai: 'กิ' }, { char: 'ぐ', romaji: 'gu', thai: 'กุ' }, { char: 'げ', romaji: 'ge', thai: 'เกะ' }, { char: 'ご', romaji: 'go', thai: 'โกะ' },
            { char: 'ざ', romaji: 'za', thai: 'ซะ (Za)' }, { char: 'じ', romaji: 'ji', thai: 'จิ (Ji)' }, { char: 'ず', romaji: 'zu', thai: 'ซุ (Zu)' }, { char: 'ぜ', romaji: 'ze', thai: 'เซะ (Ze)' }, { char: 'ぞ', romaji: 'zo', thai: 'โซะ (Zo)' },
            { char: 'だ', romaji: 'da', thai: 'ดะ' }, { char: 'ぢ', romaji: 'ji', thai: 'จิ (Di)' }, { char: 'づ', romaji: 'zu', thai: 'ซุ (Du)' }, { char: 'で', romaji: 'de', thai: 'เดะ' }, { char: 'ど', romaji: 'do', thai: 'โดะ' },
            { char: 'ば', romaji: 'ba', thai: 'บะ' }, { char: 'び', romaji: 'bi', thai: 'บิ' }, { char: 'ぶ', romaji: 'bu', thai: 'บุ' }, { char: 'べ', romaji: 'be', thai: 'เบะ' }, { char: 'ぼ', romaji: 'bo', thai: 'โบะ' },
            { char: 'ぱ', romaji: 'pa', thai: 'พะ' }, { char: 'ぴ', romaji: 'pi', thai: 'พิ' }, { char: 'ぷ', romaji: 'pu', thai: 'พุ' }, { char: 'ぺ', romaji: 'pe', thai: 'เพะ' }, { char: 'ぽ', romaji: 'po', thai: 'โพะ' },
        ];

        const katakanaData = [
            { char: 'ア', romaji: 'a', thai: 'อะ' }, { char: 'イ', romaji: 'i', thai: 'อิ' }, { char: 'ウ', romaji: 'u', thai: 'อุ' }, { char: 'エ', romaji: 'e', thai: 'เอะ' }, { char: 'オ', romaji: 'o', thai: 'โอะ' },
            { char: 'カ', romaji: 'ka', thai: 'คะ' }, { char: 'キ', romaji: 'ki', thai: 'คิ' }, { char: 'ク', romaji: 'ku', thai: 'คุ' }, { char: 'ケ', romaji: 'ke', thai: 'เคะ' }, { char: 'コ', romaji: 'ko', thai: 'โคะ' },
            { char: 'サ', romaji: 'sa', thai: 'ซะ' }, { char: 'シ', romaji: 'shi', thai: 'ชิ' }, { char: 'ス', romaji: 'su', thai: 'สุ' }, { char: 'セ', romaji: 'se', thai: 'เซะ' }, { char: 'ソ', romaji: 'so', thai: 'โซะ' },
            { char: 'タ', romaji: 'ta', thai: 'ทะ' }, { char: 'チ', romaji: 'chi', thai: 'ฌิ' }, { char: 'ツ', romaji: 'tsu', thai: 'ทสึ' }, { char: 'テ', romaji: 'te', thai: 'เทะ' }, { char: 'ト', romaji: 'to', thai: 'โทะ' },
            { char: 'ナ', romaji: 'na', thai: 'นะ' }, { char: 'ニ', romaji: 'ni', thai: 'นิ' }, { char: 'ヌ', romaji: 'nu', thai: 'นุ' }, { char: 'ネ', romaji: 'ne', thai: 'เนะ' }, { char: 'ノ', romaji: 'no', thai: 'โนะ' },
            { char: 'ハ', romaji: 'ha', thai: 'ฮะ' }, { char: 'ヒ', romaji: 'hi', thai: 'ฮิ' }, { char: 'フ', romaji: 'fu', thai: 'ฟุ' }, { char: 'ヘ', romaji: 'he', thai: 'เฮะ' }, { char: 'ホ', romaji: 'ho', thai: 'โฮะ' },
            { char: 'マ', romaji: 'ma', thai: 'มะ' }, { char: 'ミ', romaji: 'mi', thai: 'มิ' }, { char: 'ム', romaji: 'mu', thai: 'มุ' }, { char: 'メ', romaji: 'me', thai: 'เมะ' }, { char: 'モ', romaji: 'mo', thai: 'โมะ' },
            { char: 'ヤ', romaji: 'ya', thai: 'ยะ' }, { char: 'ユ', romaji: 'yu', thai: 'ยุ' }, { char: 'ヨ', romaji: 'yo', thai: 'โยะ' },
            { char: 'ラ', romaji: 'ra', thai: 'ระ' }, { char: 'リ', romaji: 'ri', thai: 'ริ' }, { char: 'ル', romaji: 'ru', thai: 'รุ' }, { char: 'レ', romaji: 're', thai: 'เระ' }, { char: 'ロ', romaji: 'ro', thai: 'โระ' },
            { char: 'ワ', romaji: 'wa', thai: 'วะ' }, { char: 'ヲ', romaji: 'wo', thai: 'โวะ' }, { char: 'ン', romaji: 'n', thai: 'อึน/น' },
            { char: 'ガ', romaji: 'ga', thai: 'กะ' }, { char: 'ギ', romaji: 'gi', thai: 'กิ' }, { char: 'グ', romaji: 'gu', thai: 'กุ' }, { char: 'ゲ', romaji: 'ge', thai: 'เกะ' }, { char: 'ゴ', romaji: 'go', thai: 'โกะ' },
            { char: 'ザ', romaji: 'za', thai: 'ซะ (Za)' }, { char: 'ジ', romaji: 'ji', thai: 'จิ (Ji)' }, { char: 'ズ', romaji: 'zu', thai: 'ซุ (Zu)' }, { char: 'ゼ', romaji: 'ze', thai: 'เซะ (Ze)' }, { char: 'ゾ', romaji: 'zo', thai: 'โซะ (Zo)' },
            { char: 'ダ', romaji: 'da', thai: 'ดะ' }, { char: 'ヂ', romaji: 'ji', thai: 'จิ (Di)' }, { char: 'ヅ', romaji: 'zu', thai: 'ซุ (Du)' }, { char: 'デ', romaji: 'de', thai: 'เดะ' }, { char: 'ド', romaji: 'do', thai: 'โดะ' },
            { char: 'バ', romaji: 'ba', thai: 'บะ' }, { char: 'ビ', romaji: 'bi', thai: 'บิ' }, { char: 'ブ', romaji: 'bu', thai: 'บุ' }, { char: 'ベ', romaji: 'be', thai: 'เบะ' }, { char: 'ボ', romaji: 'bo', thai: 'โบะ' },
            { char: 'パ', romaji: 'pa', thai: 'พะ' }, { char: 'ピ', romaji: 'pi', thai: 'พิ' }, { char: 'プ', romaji: 'pu', thai: 'พุ' }, { char: 'ペ', romaji: 'pe', thai: 'เพะ' }, { char: 'ポ', romaji: 'po', thai: 'โพะ' },
        ];

        // --- N5 VOCABULARY (~200 Items with Reading & Kanji) ---
        const n5VocabData = [
            // Pronouns & People
            { char: 'わたし', kanji: '私', reading: 'วา-ตา-ชิ', thai: 'ฉัน/ผม' },
            { char: 'あなた', kanji: '', reading: 'อะ-นา-ตะ', thai: 'คุณ' },
            { char: 'ひと', kanji: '人', reading: 'ฮิ-โตะ', thai: 'คน' },
            { char: 'こども', kanji: '子供', reading: 'โค-โด-โมะ', thai: 'เด็ก' },
            { char: 'おとこ', kanji: '男', reading: 'โอ-โต-โกะ', thai: 'ผู้ชาย' },
            { char: 'おんな', kanji: '女', reading: 'ออน-นะ', thai: 'ผู้หญิง' },
            { char: 'せんせい', kanji: '先生', reading: 'เซ็น-เซ', thai: 'ครู/อาจารย์' },
            { char: 'がくせい', kanji: '学生', reading: 'กะ-คุ-เซ', thai: 'นักเรียน' },
            { char: 'ともだち', kanji: '友達', reading: 'โท-โม-ดา-จิ', thai: 'เพื่อน' },
            { char: 'いしゃ', kanji: '医者', reading: 'อิ-ชะ', thai: 'หมอ' },
            { char: 'おとな', kanji: '大人', reading: 'โอ-โต-นะ', thai: 'ผู้ใหญ่' },
            { char: 'がいこくじん', kanji: '外国人', reading: 'ไก-โค-คุ-จิน', thai: 'ชาวต่างชาติ' },
            
            // Family
            { char: 'かぞく', kanji: '家族', reading: 'คา-โซ-คุ', thai: 'ครอบครัว' },
            { char: 'ちち', kanji: '父', reading: 'ชิ-ชิ', thai: 'พ่อ (ของฉัน)' },
            { char: 'はは', kanji: '母', reading: 'ฮะ-ฮะ', thai: 'แม่ (ของฉัน)' },
            { char: 'あに', kanji: '兄', reading: 'อะ-นิ', thai: 'พี่ชาย (ของฉัน)' },
            { char: 'あね', kanji: '姉', reading: 'อะ-เนะ', thai: 'พี่สาว (ของฉัน)' },
            { char: 'おとうと', kanji: '弟', reading: 'โอ-โท-โตะ', thai: 'น้องชาย' },
            { char: 'いもうと', kanji: '妹', reading: 'อิ-โม-โตะ', thai: 'น้องสาว' },
            { char: 'おとうさん', kanji: 'お父さん', reading: 'โอ-โต-ซัง', thai: 'คุณพ่อ' },
            { char: 'おかあさん', kanji: 'お母さん', reading: 'โอ-คา-ซัง', thai: 'คุณแม่' },
            { char: 'おじいさん', kanji: 'お爺さん', reading: 'โอ-จี-ซัง', thai: 'คุณปู่/ตา' },
            { char: 'おばあさん', kanji: 'お婆さん', reading: 'โอ-บา-ซัง', thai: 'คุณย่า/ยาย' },

            // Time & Days
            { char: 'いま', kanji: '今', reading: 'อิ-มะ', thai: 'ตอนนี้' },
            { char: 'きょう', kanji: '今日', reading: 'เคียว', thai: 'วันนี้' },
            { char: 'きのう', kanji: '昨日', reading: 'คิ-โน', thai: 'เมื่อวาน' },
            { char: 'あした', kanji: '明日', reading: 'อะ-ชิ-ตะ', thai: 'พรุ่งนี้' },
            { char: 'あさ', kanji: '朝', reading: 'อะ-ซะ', thai: 'ตอนเช้า' },
            { char: 'ひる', kanji: '昼', reading: 'ฮิ-รุ', thai: 'ตอนกลางวัน' },
            { char: 'ばん', kanji: '晩', reading: 'บัง', thai: 'ตอนเย็น' },
            { char: 'よる', kanji: '夜', reading: 'โย-รุ', thai: 'ตอนกลางคืน' },
            { char: 'まいにち', kanji: '毎日', reading: 'ไม-นิ-ชิ', thai: 'ทุกวัน' },
            { char: 'じかん', kanji: '時間', reading: 'จิ-คัง', thai: 'เวลา' },
            { char: 'げつようび', kanji: '月曜日', reading: 'เก็ท-สึ-โย-บิ', thai: 'วันจันทร์' },
            { char: 'かようび', kanji: '火曜日', reading: 'คะ-โย-บิ', thai: 'วันอังคาร' },
            { char: 'すいようび', kanji: '水曜日', reading: 'ซุ-อิ-โย-บิ', thai: 'วันพุธ' },
            { char: 'もくようび', kanji: '木曜日', reading: 'โม-คุ-โย-บิ', thai: 'วันพฤหัสบดี' },
            { char: 'きんようび', kanji: '金曜日', reading: 'คิน-โย-บิ', thai: 'วันศุกร์' },
            { char: 'どようび', kanji: '土曜日', reading: 'โด-โย-บิ', thai: 'วันเสาร์' },
            { char: 'にちようび', kanji: '日曜日', reading: 'นิ-ชิ-โย-บิ', thai: 'วันอาทิตย์' },
            { char: 'せんしゅう', kanji: '先週', reading: 'เซ็น-ชู', thai: 'สัปดาห์ที่แล้ว' },
            { char: 'こんしゅう', kanji: '今週', reading: 'คน-ชู', thai: 'สัปดาห์นี้' },
            { char: 'らいしゅう', kanji: '来週', reading: 'ไร-ชู', thai: 'สัปดาห์หน้า' },

            // Greetings & Expressions (Usually Kana only, some have Kanji but rarely used in N5)
            { char: 'おはよう', kanji: '', reading: 'โอ-ฮา-โย', thai: 'สวัสดีตอนเช้า' },
            { char: 'こんにちは', kanji: '', reading: 'คน-นิ-ชิ-วะ', thai: 'สวัสดี' },
            { char: 'こんばんは', kanji: '', reading: 'คม-บัง-วะ', thai: 'สวัสดีตอนเย็น' },
            { char: 'さようなら', kanji: '', reading: 'ซา-โย-นา-ระ', thai: 'ลาก่อน' },
            { char: 'ありがとう', kanji: '', reading: 'อะ-ริ-กา-โตะ', thai: 'ขอบคุณ' },
            { char: 'すみません', kanji: '', reading: 'ซุ-มิ-มา-เซ็น', thai: 'ขอโทษ' },
            { char: 'はい', kanji: '', reading: 'ไฮ', thai: 'ใช่/ครับ/ค่ะ' },
            { char: 'いいえ', kanji: '', reading: 'อี-เอะ', thai: 'ไม่/เปล่า' },
            { char: 'はじめまして', kanji: '', reading: 'ฮา-จิ-เม-มา-ชิ-เตะ', thai: 'ยินดีที่ได้รู้จัก' },

            // Places
            { char: 'がっこう', kanji: '学校', reading: 'กัค-โค', thai: 'โรงเรียน' },
            { char: 'いえ', kanji: '家', reading: 'อิ-เอะ', thai: 'บ้าน' },
            { char: 'へや', kanji: '部屋', reading: 'เฮ-ยะ', thai: 'ห้อง' },
            { char: 'トイレ', kanji: '', reading: 'โท-อิ-เระ', thai: 'ห้องน้ำ' },
            { char: 'だいどころ', kanji: '台所', reading: 'ได-โด-โค-โระ', thai: 'ห้องครัว' },
            { char: 'かいしゃ', kanji: '会社', reading: 'ไค-ฉะ', thai: 'บริษัท' },
            { char: 'びょういん', kanji: '病院', reading: 'เบียว-อิน', thai: 'โรงพยาบาล' },
            { char: 'ぎんこう', kanji: '銀行', reading: 'กิน-โค', thai: 'ธนาคาร' },
            { char: 'ゆうびんきょく', kanji: '郵便局', reading: 'ยู-บิน-เคียว-คุ', thai: 'ที่ทำการไปรษณีย์' },
            { char: 'えき', kanji: '駅', reading: 'เอะ-กิ', thai: 'สถานีรถไฟ' },
            { char: 'みせ', kanji: '店', reading: 'มิ-เสะ', thai: 'ร้านค้า' },
            { char: 'デパート', kanji: '', reading: 'เด-ปา-โตะ', thai: 'ห้างสรรพสินค้า' },
            { char: 'レストラン', kanji: '', reading: 'เร-สุ-โต-รัน', thai: 'ร้านอาหาร' },
            { char: 'こうえん', kanji: '公園', reading: 'โค-เอ็น', thai: 'สวนสาธารณะ' },
            { char: 'くに', kanji: '国', reading: 'คุ-นิ', thai: 'ประเทศ' },

            // Things
            { char: 'ほん', kanji: '本', reading: 'ฮน', thai: 'หนังสือ' },
            { char: 'じしょ', kanji: '辞書', reading: 'จิ-โชะ', thai: 'พจนานุกรม' },
            { char: 'えんぴつ', kanji: '鉛筆', reading: 'เอ็น-ปิ-สึ', thai: 'ดินสอ' },
            { char: 'かばん', kanji: '鞄', reading: 'คะ-บัง', thai: 'กระเป๋า' },
            { char: 'とけい', kanji: '時計', reading: 'โท-เก', thai: 'นาฬิกา' },
            { char: 'かさ', kanji: '傘', reading: 'คะ-ซะ', thai: 'ร่ม' },
            { char: 'おかね', kanji: 'お金', reading: 'โอ-คา-เนะ', thai: 'เงิน' },
            { char: 'くつ', kanji: '靴', reading: 'คุ-สึ', thai: 'รองเท้า' },
            { char: 'しんぶん', kanji: '新聞', reading: 'ชิม-บุน', thai: 'หนังสือพิมพ์' },
            { char: 'つくえ', kanji: '机', reading: 'สึ-คุ-เอะ', thai: 'โต๊ะ' },
            { char: 'いす', kanji: '椅子', reading: 'อิ-สึ', thai: 'เก้าอี้' },
            { char: 'でんわ', kanji: '電話', reading: 'เด็น-วะ', thai: 'โทรศัพท์' },
            { char: 'じてんしゃ', kanji: '自転車', reading: 'จิ-เต็น-ฉะ', thai: 'จักรยาน' },
            { char: 'くるま', kanji: '車', reading: 'คุ-รุ-มะ', thai: 'รถยนต์' },
            { char: 'でんしゃ', kanji: '電車', reading: 'เด็น-ฉะ', thai: 'รถไฟฟ้า' },
            { char: 'バス', kanji: '', reading: 'บะ-สึ', thai: 'รถเมล์' },
            { char: 'ひこうき', kanji: '飛行機', reading: 'ฮิ-โค-กิ', thai: 'เครื่องบิน' },
            { char: 'てがみ', kanji: '手紙', reading: 'เท-กะ-มิ', thai: 'จดหมาย' },
            { char: 'しゃしん', kanji: '写真', reading: 'ชา-ชิน', thai: 'รูปถ่าย' },
            { char: 'きっぷ', kanji: '切符', reading: 'คิป-ปุ', thai: 'ตั๋ว' },

            // Food & Drink
            { char: 'ごはん', kanji: 'ご飯', reading: 'โก-ฮัง', thai: 'ข้าว/อาหาร' },
            { char: 'パン', kanji: '', reading: 'ปัง', thai: 'ขนมปัง' },
            { char: 'にく', kanji: '肉', reading: 'นิ-คุ', thai: 'เนื้อ' },
            { char: 'さかな', kanji: '魚', reading: 'ซะ-กะ-นะ', thai: 'ปลา' },
            { char: 'やさい', kanji: '野菜', reading: 'ยะ-ไซ', thai: 'ผัก' },
            { char: 'くだもの', kanji: '果物', reading: 'คุ-ดา-โม-โนะ', thai: 'ผลไม้' },
            { char: 'たまご', kanji: '卵', reading: 'ทะ-มะ-โกะ', thai: 'ไข่' },
            { char: 'みず', kanji: '水', reading: 'มิ-ซุ', thai: 'น้ำ' },
            { char: 'おちゃ', kanji: 'お茶', reading: 'โอ-ชะ', thai: 'ชา' },
            { char: 'ぎゅうにゅう', kanji: '牛乳', reading: 'กิว-นิว', thai: 'นมวัว' },
            { char: 'コーヒー', kanji: '', reading: 'โค-ฮี', thai: 'กาแฟ' },
            { char: 'おさけ', kanji: 'お酒', reading: 'โอ-ซะ-เกะ', thai: 'เหล้า' },
            { char: 'りょうり', kanji: '料理', reading: 'เรียว-ริ', thai: 'อาหาร/การทำอาหาร' },

            // Adjectives
            { char: 'おおきい', kanji: '大きい', reading: 'โอ-คี', thai: 'ใหญ่' },
            { char: 'ちいさい', kanji: '小さい', reading: 'ชี-ไซ', thai: 'เล็ก' },
            { char: 'あたらしい', kanji: '新しい', reading: 'อะ-ตะ-รา-ชี', thai: 'ใหม่' },
            { char: 'ふるい', kanji: '古い', reading: 'ฟุ-รุ-อิ', thai: 'เก่า' },
            { char: 'いい', kanji: '', reading: 'อี', thai: 'ดี' },
            { char: 'わるい', kanji: '悪い', reading: 'วะ-รุ-อิ', thai: 'เลว/ไม่ดี' },
            { char: 'あつい', kanji: '暑い', reading: 'อะ-สึ-อิ', thai: 'ร้อน' },
            { char: 'さむい', kanji: '寒い', reading: 'ซะ-มุ-อิ', thai: 'หนาว' },
            { char: 'つめたい', kanji: '冷たい', reading: 'สึ-เม-ไท', thai: 'เย็น (สัมผัส)' },
            { char: 'むずかしい', kanji: '難しい', reading: 'มุ-ซุ-กะ-ชี', thai: 'ยาก' },
            { char: 'やさしい', kanji: '易しい', reading: 'ยะ-ซะ-ชี', thai: 'ง่าย/ใจดี' },
            { char: 'たかい', kanji: '高い', reading: 'ทะ-ไค', thai: 'แพง/สูง' },
            { char: 'やすい', kanji: '安い', reading: 'ยะ-สุ-อิ', thai: 'ราคาถูก' },
            { char: 'おいしい', kanji: '美味しい', reading: 'โอ-อิ-ชี', thai: 'อร่อย' },
            { char: 'たのしい', kanji: '楽しい', reading: 'ทะ-โน-ชี', thai: 'สนุก' },
            { char: 'おもしろい', kanji: '面白い', reading: 'โอ-โม-ชิ-โร-อิ', thai: 'น่าสนใจ' },
            { char: 'いそがしい', kanji: '忙しい', reading: 'อิ-โซ-กะ-ชี', thai: 'ยุ่ง' },
            { char: 'しろい', kanji: '白い', reading: 'ชิ-โร-อิ', thai: 'สีขาว' },
            { char: 'くろい', kanji: '黒い', reading: 'คุ-โร-อิ', thai: 'สีดำ' },
            { char: 'あかい', kanji: '赤い', reading: 'อะ-ไค', thai: 'สีแดง' },
            { char: 'あおい', kanji: '青い', reading: 'อะ-โอ-อิ', thai: 'สีน้ำเงิน' },
            { char: 'すき', kanji: '好き', reading: 'สุ-กิ', thai: 'ชอบ' },
            { char: 'きらい', kanji: '嫌い', reading: 'คิ-ไร', thai: 'เกลียด' },
            { char: 'きれい', kanji: '綺麗', reading: 'คิ-เร', thai: 'สวย/สะอาด' },
            { char: 'ゆうめい', kanji: '有名', reading: 'ยู-เม', thai: 'มีชื่อเสียง' },
            { char: 'しずか', kanji: '静か', reading: 'ชิ-ซุ-กะ', thai: 'เงียบ' },
            { char: 'げんき', kanji: '元気', reading: 'เก็ง-กิ', thai: 'สบายดี' },
            { char: 'ひま', kanji: '暇', reading: 'ฮิ-มะ', thai: 'ว่าง' },
            { char: 'たいせつ', kanji: '大切', reading: 'ไท-เซ็ต-สึ', thai: 'สำคัญ' },
            { char: 'じょうず', kanji: '上手', reading: 'โจ-ซุ', thai: 'เก่ง' },
            { char: 'へた', kanji: '下手', reading: 'เฮ-ตะ', thai: 'ไม่เก่ง' },

            // Verbs
            { char: 'たべます', kanji: '食べます', reading: 'ทะ-เบ-มา-สึ', thai: 'กิน' },
            { char: 'のみます', kanji: '飲みます', reading: 'โน-มิ-มา-สึ', thai: 'ดื่ม' },
            { char: 'かいます', kanji: '買います', reading: 'ไค-มา-สึ', thai: 'ซื้อ' },
            { char: 'みます', kanji: '見ます', reading: 'มิ-มา-สึ', thai: 'ดู' },
            { char: 'ききます', kanji: '聞きます', reading: 'คิ-กิ-มา-สึ', thai: 'ฟัง/ถาม' },
            { char: 'よみます', kanji: '読みます', reading: 'โย-มิ-มา-สึ', thai: 'อ่าน' },
            { char: 'かきます', kanji: '書きます', reading: 'คะ-กิ-มา-สึ', thai: 'เขียน' },
            { char: 'いきます', kanji: '行きます', reading: 'อิ-กิ-มา-สึ', thai: 'ไป' },
            { char: 'きます', kanji: '来ます', reading: 'คิ-มา-สึ', thai: 'มา' },
            { char: 'かえります', kanji: '帰ります', reading: 'คา-เอ-ริ-มา-สึ', thai: 'กลับ' },
            { char: 'あいます', kanji: '会います', reading: 'ไอ-มา-สึ', thai: 'พบ/เจอ' },
            { char: 'はなします', kanji: '話します', reading: 'ฮา-นา-ชิ-มา-สึ', thai: 'พูดคุย' },
            { char: 'べんきょうします', kanji: '勉強します', reading: 'เบ็น-เคียว-ชิ-มา-สึ', thai: 'เรียน' },
            { char: 'あそびます', kanji: '遊びます', reading: 'อะ-โซ-บิ-มา-สึ', thai: 'เที่ยวเล่น' },
            { char: 'およぎます', kanji: '泳ぎます', reading: 'โอ-โย-กิ-มา-สึ', thai: 'ว่ายน้ำ' },
            { char: 'まちます', kanji: '待ちます', reading: 'มา-ชิ-มา-สึ', thai: 'รอ' },
            { char: 'わかります', kanji: '分かります', reading: 'วา-กา-ริ-มา-สึ', thai: 'เข้าใจ' },
            { char: 'あります', kanji: '', reading: 'อะ-ริ-มา-สึ', thai: 'มี (สิ่งของ)' },
            { char: 'います', kanji: '', reading: 'อิ-มา-สึ', thai: 'มี/อยู่ (คน/สัตว์)' },
            { char: 'ねます', kanji: '寝ます', reading: 'เน-มา-สึ', thai: 'นอน' },
            { char: 'おきます', kanji: '起きます', reading: 'โอ-กิ-มา-สึ', thai: 'ตื่น' },
            { char: 'あげます', kanji: '', reading: 'อะ-เก-มา-สึ', thai: 'ให้' },
            { char: 'もらいます', kanji: '', reading: 'โม-ไร-มา-สึ', thai: 'ได้รับ' },
            { char: 'かし', kanji: '貸します', reading: 'คะ-ชิ', thai: 'ให้ยืม' },
            { char: 'かります', kanji: '借ります', reading: 'คะ-ริ-มา-สึ', thai: 'ขอยืม' },
            { char: 'おしえます', kanji: '教えます', reading: 'โอ-ชิ-เอ-มา-สึ', thai: 'สอน' },
            { char: 'ならいます', kanji: '習います', reading: 'นา-ไร-มา-สึ', thai: 'เรียนรู้' },
            { char: 'かけます', kanji: '', reading: 'คะ-เก-มา-สึ', thai: 'โทรศัพท์' },
            { char: 'はたらきます', kanji: '働きます', reading: 'ฮา-ตะ-รา-กิ-มา-สึ', thai: 'ทำงาน' },
            { char: 'はじまります', kanji: '始まります', reading: 'ฮา-จิ-มา-ริ-มา-สึ', thai: 'เริ่ม' },
            { char: 'おわります', kanji: '終わります', reading: 'โอ-วะ-ริ-มา-สึ', thai: 'จบ/เสร็จ' },

            // Misc
            { char: 'なまえ', kanji: '名前', reading: 'นา-มา-เอะ', thai: 'ชื่อ' },
            { char: 'なん / なに', kanji: '何', reading: 'นั่น/นะ-นิ', thai: 'อะไร' },
            { char: 'だれ', kanji: '誰', reading: 'ดา-เระ', thai: 'ใคร' },
            { char: 'どこ', kanji: '', reading: 'โด-โกะ', thai: 'ที่ไหน' },
            { char: 'いつ', kanji: '', reading: 'อิ-สึ', thai: 'เมื่อไหร่' },
            { char: 'どうして', kanji: '', reading: 'โด-ชิ-เตะ', thai: 'ทำไม' },
            { char: 'どう', kanji: '', reading: 'โด', thai: 'อย่างไร' },
            { char: 'どの', kanji: '', reading: 'โด-โนะ', thai: 'อันไหน/คนไหน' },
            { char: 'これ', kanji: '', reading: 'โค-เระ', thai: 'อันนี้' },
            { char: 'それ', kanji: '', reading: 'โซ-เระ', thai: 'อันนั้น' },
            { char: 'あれ', kanji: '', reading: 'อะ-เระ', thai: 'อันโน้น' },
            { char: 'ここ', kanji: '', reading: 'โค-โกะ', thai: 'ที่นี่' },
            { char: 'そこ', kanji: '', reading: 'โซ-โกะ', thai: 'ที่นั่น' },
            { char: 'あそこ', kanji: '', reading: 'อะ-โซ-โกะ', thai: 'ที่โน่น' },
        ];

        // --- STATE VARIABLES ---
        let currentMode = null;
        let activeData = [];
        let currentQuestion = null;
        let score = 0;
        let highScore = 0;
        let isProcessing = false; 
        let lastChar = null; 

        // --- DOM ELEMENTS ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const mainBody = document.getElementById('main-body');
        
        const questionChar = document.getElementById('question-char');
        const questionKanji = document.getElementById('question-kanji');
        const questionLabel = document.getElementById('question-label');
        const questionSub = document.getElementById('question-sub');
        const feedbackText = document.getElementById('feedback-text');
        const optionsGrid = document.getElementById('options-grid');
        const scoreDisplay = document.getElementById('score-display');
        const highscoreDisplay = document.getElementById('highscore-display');
        const modeBadge = document.getElementById('mode-badge');
        const cardContainer = document.getElementById('card-container');
        const sparkleIcon = document.getElementById('sparkle-icon');

        // --- FUNCTIONS ---

        function startGame(mode) {
            currentMode = mode;
            score = 0;
            lastChar = null;

            // Set Data Source
            if (mode === 'hiragana') activeData = hiraganaData;
            else if (mode === 'katakana') activeData = katakanaData;
            else if (mode === 'mixed') activeData = [...hiraganaData, ...katakanaData];
            else if (mode === 'n5' || mode === 'reading') activeData = n5VocabData;

            // Theme Styling
            updateTheme(mode);

            // Load High Score
            const savedScore = localStorage.getItem(`quiz_highscore_${mode}`);
            highScore = savedScore ? parseInt(savedScore) : 0;
            updateScoreUI();

            // Switch Screen
            menuScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Start First Question
            generateQuestion();
        }

        function returnToMenu() {
            gameScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
            resetTheme();
        }

        function updateTheme(mode) {
            mainBody.className = "min-h-screen flex flex-col transition-colors duration-500"; 
            scoreDisplay.className = "text-2xl font-bold transition-all";
            questionSub.classList.add('hidden'); 
            
            // Default hidden
            questionKanji.classList.add('hidden');

            if (mode === 'katakana') {
                mainBody.classList.add('bg-blue-50', 'text-slate-800');
                modeBadge.innerText = "KATAKANA";
                scoreDisplay.classList.add('text-blue-600');
                questionLabel.innerText = "นี่คือตัวอะไร?";
            } else if (mode === 'mixed') {
                mainBody.classList.add('bg-orange-50', 'text-slate-800');
                modeBadge.innerText = "MIXED MODE";
                scoreDisplay.classList.add('text-orange-600');
                questionLabel.innerText = "นี่คือตัวอะไร?";
            } else if (mode === 'n5') {
                mainBody.classList.add('bg-emerald-50', 'text-slate-800');
                modeBadge.innerText = "N5 VOCAB";
                scoreDisplay.classList.add('text-emerald-600');
                questionLabel.innerText = "แปลว่าอะไร?";
            } else if (mode === 'reading') {
                mainBody.classList.add('bg-violet-50', 'text-slate-800');
                modeBadge.innerText = "READING";
                scoreDisplay.classList.add('text-violet-600');
                questionLabel.innerText = "อ่านว่าอะไร?";
                questionSub.classList.remove('hidden'); 
            } else {
                mainBody.classList.add('bg-rose-50', 'text-slate-800');
                modeBadge.innerText = "HIRAGANA";
                scoreDisplay.classList.add('text-rose-600');
                questionLabel.innerText = "นี่คือตัวอะไร?";
            }
        }

        function resetTheme() {
            mainBody.className = "bg-rose-50 text-slate-800 min-h-screen flex flex-col transition-colors duration-500";
        }

        function generateQuestion() {
            isProcessing = false;
            
            // 1. Random Correct
            let correct;
            let attempts = 0;
            do {
                const idx = Math.floor(Math.random() * activeData.length);
                correct = activeData[idx];
                attempts++;
            } while (correct.char === lastChar && activeData.length > 1 && attempts < 10);
            
            lastChar = correct.char;
            currentQuestion = correct;

            // 2. Random Distractors
            let distractors = [];
            while (distractors.length < 3) {
                const d = activeData[Math.floor(Math.random() * activeData.length)];
                
                let isDupe = false;
                if (d.char === correct.char) isDupe = true;
                
                if (currentMode === 'n5') {
                    if (distractors.some(dist => dist.thai === d.thai)) isDupe = true;
                } else if (currentMode === 'reading') {
                    if (distractors.some(dist => dist.reading === d.reading)) isDupe = true;
                } else {
                    if (distractors.some(dist => dist.thai === d.thai)) isDupe = true;
                }
                
                if (!isDupe) {
                    distractors.push(d);
                }
            }

            // 3. Shuffle
            const allOptions = [...distractors, correct];
            for (let i = allOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allOptions[i], allOptions[j]] = [allOptions[j], allOptions[i]];
            }

            renderQuestion(allOptions);
        }

        function renderQuestion(options) {
            // Reset UI States
            cardContainer.className = "relative w-full bg-white rounded-3xl shadow-xl p-8 mb-4 flex flex-col items-center justify-center min-h-[260px] transition-all duration-200 border-2 border-transparent animate-pop";
            
            // --- Kanji Display Logic ---
            if ((currentMode === 'n5' || currentMode === 'reading') && currentQuestion.kanji) {
                questionKanji.innerText = currentQuestion.kanji;
                questionKanji.classList.remove('hidden');
            } else {
                questionKanji.classList.add('hidden');
            }

            questionChar.innerText = currentQuestion.char;
            
            // Sub text for Reading Mode
            if (currentMode === 'reading') {
                questionSub.innerText = `(${currentQuestion.thai})`;
            }

            // Font Scaling
            questionChar.className = "text-center font-black mb-2 text-slate-800 transition-all duration-200 break-words w-full";
            const len = currentQuestion.char.length;
            if (len <= 2) {
                questionChar.classList.add('text-9xl');
            } else if (len <= 4) {
                questionChar.classList.add('text-7xl');
            } else if (len <= 6) {
                questionChar.classList.add('text-6xl');
            } else {
                questionChar.classList.add('text-5xl');
            }

            if (currentMode === 'katakana') questionChar.classList.add('text-slate-800');
            
            feedbackText.innerText = "";
            sparkleIcon.classList.add('hidden');

            optionsGrid.innerHTML = "";
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = getButtonClass('default');
                
                if (currentMode === 'reading') {
                    btn.innerText = opt.reading;
                } else if (currentMode === 'n5') {
                    btn.innerText = opt.thai; 
                } else {
                    btn.innerText = opt.thai;
                }

                btn.onclick = () => handleAnswer(opt, btn);
                optionsGrid.appendChild(btn);
            });
        }

        function getButtonClass(state) {
            const base = "h-16 md:h-20 rounded-xl text-lg md:text-xl font-bold transition-all duration-100 flex items-center justify-center relative shadow-sm border-2 px-2 ";
            
            // Theme dependent borders
            let themeBorder = "border-rose-100 hover:bg-rose-50 active:scale-95 text-slate-700";
            if (currentMode === 'katakana') themeBorder = "border-blue-100 hover:bg-blue-50 active:scale-95 text-slate-700";
            if (currentMode === 'mixed') themeBorder = "border-orange-100 hover:bg-orange-50 active:scale-95 text-slate-700";
            if (currentMode === 'n5') themeBorder = "border-emerald-100 hover:bg-emerald-50 active:scale-95 text-slate-700";
            if (currentMode === 'reading') themeBorder = "border-violet-100 hover:bg-violet-50 active:scale-95 text-slate-700";

            if (state === 'default') return base + "bg-white " + themeBorder;
            if (state === 'correct') return base + "bg-green-100 border-green-500 text-green-700 scale-105 shadow-md z-10";
            if (state === 'wrong') return base + "bg-red-100 border-red-500 text-red-700 opacity-60 cursor-not-allowed"; 
            if (state === 'disabled') return base + "bg-gray-50 border-transparent text-gray-300 cursor-not-allowed";
        }

        function handleAnswer(selected, btnElement) {
            if (isProcessing) return; 
            if (btnElement.disabled) return;

            const isCorrect = selected.char === currentQuestion.char;

            if (isCorrect) {
                // --- CORRECT ---
                isProcessing = true;
                score++;
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem(`quiz_highscore_${currentMode}`, highScore);
                }
                updateScoreUI();

                // UI Updates
                btnElement.className = getButtonClass('correct');
                cardContainer.classList.add('border-green-400');
                questionChar.classList.add('text-green-500', 'scale-110');
                
                if (currentMode === 'reading' || currentMode === 'n5') {
                     feedbackText.innerText = `ถูกต้อง! (${currentQuestion.reading})`;
                } else {
                     feedbackText.innerText = `ถูกต้อง! (${currentQuestion.romaji})`;
                }
               
                feedbackText.className = "font-bold text-lg text-green-600 animate-bounce-in";
                sparkleIcon.classList.remove('hidden');

                const buttons = optionsGrid.querySelectorAll('button');
                buttons.forEach(b => {
                    if (b !== btnElement) b.disabled = true;
                });

                setTimeout(generateQuestion, 1000);

            } else {
                // --- WRONG ---
                score = 0;
                updateScoreUI();

                btnElement.className = getButtonClass('wrong');
                btnElement.disabled = true;

                cardContainer.classList.add('animate-shake');
                questionChar.classList.add('text-red-500');

                setTimeout(() => {
                     cardContainer.classList.remove('animate-shake');
                     questionChar.classList.remove('text-red-500');
                }, 500);

                feedbackText.innerText = "ผิดครับ ลองใหม่อีกครั้ง!";
                feedbackText.className = "font-bold text-lg text-red-500";
            }
        }

        function updateScoreUI() {
            scoreDisplay.innerText = score;
            highscoreDisplay.innerText = highScore;
        }

        function resetScore() {
            score = 0;
            updateScoreUI();
            generateQuestion();
        }

    </script>
</body>
</html>
